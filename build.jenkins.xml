<?xml version="1.0"?>
<project basedir="." default="help">

	<property name="rootdir" value="${project.basedir}" override="true" />

	<target name="help">
		<echo message="Available targets" />
		<echo message="=================" />
		<echo message="phing build Builds project for Jenkins" />
		<echo message="phing help  Shows this help screen" />
	</target>

	<target name="build" depends="prepare,phpunit,phpcs,phpmd,phpcpd,phploc" />

	<target name="prepare" depends="clean">
		<exec command="composer update" passthru="true" />
		<mkdir dir="${rootdir}/build/api/" />
		<mkdir dir="${rootdir}/build/coverage/" />
		<mkdir dir="${rootdir}/build/logs/" />
		<mkdir dir="${rootdir}/build/pdepend/" />
		<mkdir dir="${rootdir}/build/phpdox/" />
	</target>

	<target name="clean">
		<if>
			<available file="${rootdir}/build/" type="dir" />
			<then>
				<delete dir="${rootdir}/build/" />
			</then>
		</if>
	</target>

	<target name="phpunit">
		<exec command="${rootdir}/vendor/bin/phpunit -c ${rootdir}/phpunit.xml --colors --log-junit ${rootdir}/build/logs/junit.xml --coverage-clover ${rootdir}/build/logs/clover.xml --coverage-html ${rootdir}/build/coverage/ --coverage-crap4j ${rootdir}/build/logs/crap4j.xml" logoutput="true" passthru="true" />
	</target>

	<target name="phpcs">
		<exec command="${rootdir}/vendor/bin/phpcs -p --extensions=php --standard=PSR2 --report=checkstyle --report-file=${rootdir}/build/logs/checkstyle.xml ${rootdir}/lib" escape="false" logoutput="true" passthru="true" />
	</target>

	<target name="phpmd">
		<exec command="${rootdir}/vendor/bin/phpmd ${rootdir}/lib xml codesize,unusedcode,design --reportfile ${rootdir}/build/logs/pmd.xml" logoutput="true" passthru="true" />
	</target>

	<target name="phpcpd">
		<exec command="${rootdir}/vendor/bin/phpcpd --min-lines 7 --min-tokens 65 --log-pmd ${rootdir}/build/logs/pmd-cpd.xml ${rootdir}/lib" logoutput="true" passthru="true" />
	</target>

	<target name="phploc">
		<exec command="${rootdir}/vendor/bin/phploc --log-csv ${rootdir}/build/logs/phploc.csv ${rootdir}/lib" logoutput="true" passthru="true" />
	</target>

</project>